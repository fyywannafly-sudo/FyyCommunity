-- ================================
-- Fyy PREMIUM LOADER v2.0 (UPDATED)
-- ================================
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- ================================
-- CONFIGURATION
-- ================================
local BASE_URL = "http://localhost:3000"
local SECRET_ENDPOINT = "/AOJWDOJWAJDASODWAHI021031"
local VALIDATE_URL = BASE_URL .. "/validate"
local SCRIPT_URL = BASE_URL .. SECRET_ENDPOINT

-- SETTINGS
local ENABLE_LOGS = true -- Set false untuk hide semua print
local MAX_RETRIES = 3
local RETRY_DELAY = 2

-- ================================
-- UTILITY FUNCTIONS
-- ================================
local function log(...)
    if ENABLE_LOGS then
        print("[Fyy Loader]", ...)
    end
end

local function safeWait(seconds)
    local start = tick()
    while tick() - start < seconds do
        RunService.Heartbeat:Wait()
    end
end

local function getHWID()
    local hwid
    local success = pcall(function()
        hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    end)
    
    if success and hwid and hwid ~= "" then
        return hwid
    end
    
    -- Fallback method
    pcall(function()
        hwid = game:GetService("HttpService"):GenerateGUID(false)
    end)
    
    return hwid or "HWID-" .. tostring(tick())
end

-- ================================
-- WAIT FOR GAME READY
-- ================================
local function waitForGameReady()
    local attempts = 0
    local maxAttempts = 30 -- 30 detik maksimal
    
    while attempts < maxAttempts do
        local player = Players.LocalPlayer
        local character = player and player.Character
        local humanoid = character and character:FindFirstChild("Humanoid")
        
        -- Cek apakah game sudah siap
        if player and player.UserId > 0 and game.PlaceId > 0 then
            -- Optional: tunggu character load juga
            if character and humanoid then
                log("‚úÖ Game ready - Player loaded")
                return true
            elseif attempts > 10 then -- Tunggu 10 attempt untuk character
                log("‚ö†Ô∏è Game ready, character still loading")
                return true
            end
        end
        
        attempts += 1
        log("‚è≥ Waiting for game... (" .. attempts .. "/" .. maxAttempts .. ")")
        safeWait(1)
    end
    
    return false
end

-- ================================
-- VALIDATE KEY FUNCTION (UPDATE: Simpan key ke _G)
-- ================================
local function validateKey()
    -- Tunggu game ready dulu
    if not waitForGameReady() then
        log("‚ùå Game tidak ready dalam waktu yang ditentukan")
        return false
    end
    
    -- Cek key dari variabel global atau input
    local USER_KEY = _G.script_key or "YOUR_KEY_HERE" -- Ganti dengan key user
    
    if not USER_KEY or USER_KEY == "" or USER_KEY == "YOUR_KEY_HERE" then
        log("‚ùå Key tidak ditemukan")
        log("‚ÑπÔ∏è Set key dengan: _G.script_key = 'YOUR_KEY' sebelum execute loader")
        return false
    end

    local player = Players.LocalPlayer
    if not player then return false end
    
    local hwid = getHWID()
    local robloxId = player.UserId
    local username = player.Name
    local placeId = game.PlaceId
    
    log("üîç Validating key: " .. string.sub(USER_KEY, 1, 8) .. "...")
    
    -- Buat URL validasi
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&placeId=%s&username=%s",
        VALIDATE_URL,
        HttpService:UrlEncode(USER_KEY),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        tostring(placeId),
        HttpService:UrlEncode(username)
    )

    -- Retry mechanism
    for attempt = 1, MAX_RETRIES do
        local success, response = pcall(function()
            return game:HttpGet(url, true)
        end)

        if success and response and response ~= "" then
            -- Decode response
            local data
            success = pcall(function()
                data = HttpService:JSONDecode(response)
            end)
            
            if success and data then
                if data.status == "ok" then
                    -- ‚úÖ SIMPAN KEY KE GLOBAL VARIABLE UNTUK SCRIPT UTAMA
                    _G.script_key = USER_KEY
                    _G.fyy_hwid = hwid
                    _G.fyy_userid = robloxId
                    
                    log("‚úÖ Validation success")
                    log("üì¶ Key stored in _G.script_key")
                    return true, USER_KEY, hwid, robloxId, username
                else
                    -- Handle specific errors
                    local errorCode = data.code or "UNKNOWN"
                    local errorMsg = data.message or "Validation failed"
                    
                    if errorCode == "HWID_MISMATCH" then
                        Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Key sudah terikat ke device lain\nHubungi admin untuk reset HWID")
                    elseif errorCode == "BLACKLISTED" then
                        Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Key diblacklist\nHubungi owner")
                    elseif errorCode == "EXPIRED" then
                        Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Key sudah expired")
                    else
                        Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå " .. errorMsg)
                    end
                    return false
                end
            end
        end
        
        -- Retry delay
        if attempt < MAX_RETRIES then
            log("üîÑ Retry validation (" .. attempt .. "/" .. MAX_RETRIES .. ")")
            safeWait(RETRY_DELAY)
        end
    end
    
    -- Max retries reached
    Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Gagal terhubung ke server\nSilakan coba lagi nanti")
    return false
end

-- ================================
-- DOWNLOAD SCRIPT FUNCTION
-- ================================
local function downloadScript(userKey, hwid, robloxId, username)
    if not userKey then return nil end
    
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&username=%s",
        SCRIPT_URL,
        HttpService:UrlEncode(userKey),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        HttpService:UrlEncode(username)
    )
    
    log("üì• Downloading script...")
    
    for attempt = 1, MAX_RETRIES do
        local success, scriptContent = pcall(function()
            return game:HttpGet(url, true)
        end)
        
        if success and scriptContent and scriptContent ~= "" then
            -- Cek jika response error
            if string.find(scriptContent, "ERROR:") or 
               string.find(scriptContent, "ACCESS DENIED") or
               string.find(scriptContent, "KEY BLACKLISTED") then
                
                if string.find(scriptContent, "HWID MISMATCH") then
                    Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Device mismatch\nReset HWID di panel")
                elseif string.find(scriptContent, "EXPIRED") then
                    Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Key expired")
                else
                    Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Akses script ditolak")
                end
                return nil
            end
            
            log("‚úÖ Script downloaded (" .. #scriptContent .. " bytes)")
            return scriptContent
        end
        
        if attempt < MAX_RETRIES then
            log("üîÑ Retry download (" .. attempt .. "/" .. MAX_RETRIES .. ")")
            safeWait(RETRY_DELAY)
        end
    end
    
    Players.LocalPlayer:Kick("[Fyy Premium] ‚ùå Gagal download script\nCoba lagi atau hubungi admin")
    return nil
end

-- ================================
-- SAFE EXECUTE SCRIPT
-- ================================
local function safeExecute(scriptContent)
    if not scriptContent then return end
    
    -- Validasi script sebelum execute
    if #scriptContent < 100 then -- Script terlalu pendek
        log("‚ö†Ô∏è Script content terlalu pendek")
        return
    end
    
    -- Cek jika sudah ada _G.script_key (seharusnya sudah diset di validateKey)
    if not _G.script_key then
        log("‚ö†Ô∏è _G.script_key not found, re-initializing...")
        -- Optional: bisa minta input key di sini
    end
    
    -- Coba execute dengan error handling
    local success, err = pcall(function()
        local fn = loadstring(scriptContent)
        if fn then
            fn()
        end
    end)
    
    if not success then
        log("‚ùå Script execution error:", err)
        -- Tidak kick player, biar tetap bisa main
    else
        log("üéâ Premium features loaded")
    end
end

-- ================================
-- MAIN EXECUTION (UPDATE: Tangkap return value dari validateKey)
-- ================================
local function main()
    -- Tunggu game benar-benar ready
    safeWait(1)
    
    -- Validasi key dan simpan return values
    local valid, userKey, hwid, robloxId, username = validateKey()
    if not valid then
        return
    end
    
    -- Pastikan _G.script_key sudah diset
    if not _G.script_key then
        log("‚ùå _G.script_key not set after validation")
        return
    end
    
    log("üîë Using key: " .. string.sub(_G.script_key, 1, 8) .. "...")
    
    -- Download script dengan parameter yang diperlukan
    local scriptContent = downloadScript(userKey, hwid, robloxId, username)
    if not scriptContent then
        return
    end
    
    -- Execute script
    safeExecute(scriptContent)
    
    -- Background re-validation (optional)
    spawn(function()
        while true do
            safeWait(300) -- 5 menit
            if not validateKey() then
                break
            end
        end
    end)
end

-- ================================
-- INITIALIZE - DUA CARA PENGGUNAAN
-- ================================

-- CARA 1: AUTO-RUN (default)
spawn(function()
    safeWait(2) -- Tunggu 2 detik sebelum mulai
    main()
end)

-- CARA 2: MANUAL EXECUTE (jika perlu input key manual)
--[[
-- Uncomment block ini jika mau input key manual
local function manualStart()
    -- Minta input key dari user
    _G.script_key = "INPUT_KEY_DISINI" -- Ganti dengan input user
    
    -- Jalankan main
    main()
end

-- Panggil manualStart() ketika trigger tertentu
-- contoh: game:GetService("UserInputService").InputBegan:Connect(function(input)
--     if input.KeyCode == Enum.KeyCode.F5 then
--         manualStart()
--     end
-- end)
]]

-- Export functions jika diperlukan
return {
    validateKey = validateKey,
    getHWID = getHWID,
    version = "2.1",
    description = "Fyy Premium Loader with _G.script_key support"
}
