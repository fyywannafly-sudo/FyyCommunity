-- ============================================
-- FYY PREMIUM LOADER (Replit Edition)
-- ============================================

local HttpService = game:GetService("HttpService")

-- URL API REplit lo (ganti dengan URL lo)
local API_URL = "https://2cbe2093-9622-46ac-9234-c2157ec64dd8-00-cauxo43sz44y.pike.replit.dev/validate"

-- Jika URL di atas berubah, ganti dengan yang baru dari Replit Webview

local function validateKey()
    -- Cek apakah _G.script_key sudah di-set
    if not _G.script_key then
        error("[Fyy Loader] ERROR: _G.script_key belum di-set!")
        return
    end
    
    -- Get HWID dari Roblox
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    local player = game.Players.LocalPlayer
    local robloxId = player and player.UserId or 0
    local placeId = game.PlaceId
    
    -- Debug info
    print("[Fyy Loader] Validating...")
    print("- Key:", _G.script_key)
    print("- HWID:", hwid)
    print("- API URL:", API_URL)
    
    -- Build URL dengan query parameters
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&placeId=%s",
        API_URL,
        HttpService:UrlEncode(_G.script_key),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        tostring(placeId)
    )
    
    print("[Fyy Loader] Request URL:", url)
    
    -- HttpGet dengan error handling
    local success, response = pcall(function()
        return game:HttpGet(url, true)  -- true = async
    end)
    
    -- Check jika request gagal
    if not success then
        warn("[Fyy Loader] HTTP Request failed:", response)
        if player then
            player:Kick("[Fyy Loader] üî¥ Gagal menghubungi server validasi.\nCek koneksi internet atau hubungi owner.")
        end
        return
    end
    
    if not response or response == "" then
        warn("[Fyy Loader] Server returned empty response")
        if player then
            player:Kick("[Fyy Loader] üî¥ Server tidak merespon.")
        end
        return
    end
    
    print("[Fyy Loader] Raw response:", string.sub(response, 1, 200) .. "...")
    
    -- Parse JSON response
    local data
    local decodeSuccess, decodeError = pcall(function()
        data = HttpService:JSONDecode(response)
    end)
    
    if not decodeSuccess then
        warn("[Fyy Loader] JSON Decode failed:", decodeError)
        warn("Full response:", response)
        if player then
            player:Kick("[Fyy Loader] üî¥ Response server tidak valid.")
        end
        return
    end
    
    -- Debug response
    print("[Fyy Loader] Parsed response:")
    for k, v in pairs(data) do
        print("  " .. k .. ":", v)
    end
    
    -- Check validation result
    if data.status == "ok" then
        print("[Fyy Loader] ‚úÖ Validation SUCCESS!")
        print("- Code:", data.code)
        print("- Message:", data.message)
        
        -- Jika first bind, beri tahu user
        if data.code == "FIRST_BIND" then
            print("[Fyy Loader] ‚≠ê FIRST BIND: HWID berhasil diikat ke device ini.")
        end
        
        return true
    else
        print("[Fyy Loader] ‚ùå Validation FAILED!")
        print("- Error Code:", data.code)
        print("- Message:", data.message)
        
        -- Kick player dengan pesan error
        if player then
            local kickMessage = "[Fyy Loader] "
            
            if data.code == "INVALID_KEY" then
                kickMessage = kickMessage .. "üîë Key tidak valid / tidak ditemukan."
            elseif data.code == "BLACKLISTED" then
                kickMessage = kickMessage .. "‚õî Key diblacklist. Hubungi owner."
            elseif data.code == "EXPIRED" then
                kickMessage = kickMessage .. "‚åõ Key sudah expired."
            elseif data.code == "HWID_MISMATCH" then
                kickMessage = kickMessage .. "üíª HWID tidak cocok.\nReset HWID di panel Discord dulu."
            else
                kickMessage = kickMessage .. (data.message or "Key error")
            end
            
            player:Kick(kickMessage)
        end
        return false
    end
end

-- ============================================
-- EXECUTION
-- ============================================

print("[Fyy Loader] ==================================")
print("[Fyy Loader] üî• FYY PREMIUM LOADER STARTING üî•")
print("[Fyy Loader] ==================================")

-- Tunggu player jika belum ada
if not game.Players.LocalPlayer then
    game.Players.PlayerAdded:Wait()
end

-- Validasi key
local validated = validateKey()

-- Jika validasi sukses, load script utama
if validated then
    print("[Fyy Loader] üöÄ Loading main script...")
    
    -- URL script utama GitHub
    local MAIN_SCRIPT_URL = "https://raw.githubusercontent.com/fyywannafly-sudo/panel/refs/heads/main/FyyCommunity"
    
    -- Load script utama
    local success, err = pcall(function()
        loadstring(game:HttpGet(MAIN_SCRIPT_URL))()
    end)
    
    if not success then
        warn("[Fyy Loader] ‚ùå Gagal load main script:", err)
    else
        print("[Fyy Loader] ‚úÖ Main script loaded successfully!")
    end
else
    print("[Fyy Loader] ‚ùå Validation failed, script tidak di-load.")
end

print("[Fyy Loader] ==================================")
