local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

-- ================================
-- CONFIGURATION (GANTI INI SESUAI SERVER)
-- ================================
local BASE_URL = "http://localhost:3000"  -- Ganti dengan IP server kamu
local SECRET_ENDPOINT = "/IYASKIDKNTLFYYHERE"  -- SAMA DENGAN YANG DI SERVER!
local VALIDATE_URL = BASE_URL .. "/validate"
local SCRIPT_URL = BASE_URL .. SECRET_ENDPOINT

-- ================================
-- HWID FUNCTION
-- ================================
local function getHWID()
    -- Method 1: RbxAnalyticsService (recommended)
    local success, hwid = pcall(function()
        return game:GetService("RbxAnalyticsService"):GetClientId()
    end)
    
    if success and hwid and hwid ~= "" then
        return hwid
    end
    
    -- Method 2: Alternative jika method 1 gagal
    local success2, hwid2 = pcall(function()
        return game:GetService("HttpService"):GenerateGUID(false)
    end)
    
    if success2 then
        return hwid2
    end
    
    -- Method 3: Fallback
    return "HWID-" .. tostring(tick())
end

-- ================================
-- VALIDATE KEY FUNCTION
-- ================================
local function validateKey()
    -- Cek apakah key sudah diset
    if not _G.script_key or _G.script_key == "" then
        local player = Players.LocalPlayer
        if player then
            player:Kick("[Fyy Loader] ‚ùå Key tidak ditemukan.\nIsi _G.script_key terlebih dahulu!")
        end
        return false
    end

    -- Get user info
    local player = Players.LocalPlayer
    local hwid = getHWID()
    local robloxId = player and player.UserId or 0
    local username = player and player.Name or "UNKNOWN"
    local placeId = game.PlaceId
    
    print("[Fyy Loader] üîç Validating...")
    print("  Key:", string.sub(_G.script_key, 1, 8) .. "...")
    print("  HWID:", string.sub(hwid, 1, 16) .. "...")
    print("  User:", username)
    print("  UserID:", robloxId)
    print("  PlaceID:", placeId)

    -- Buat URL validasi dengan semua parameter
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&placeId=%s&username=%s",
        VALIDATE_URL,
        HttpService:UrlEncode(_G.script_key),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        tostring(placeId),
        HttpService:UrlEncode(username)
    )

    -- Kirim request validasi
    local success, response = pcall(function()
        return game:HttpGet(url, true)
    end)

    -- Cek koneksi
    if not success then
        warn("[Fyy Loader] ‚ùå Koneksi ke server gagal:", response)
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server offline / timeout\nSilakan coba lagi nanti.")
        end
        return false
    end

    if not response or response == "" then
        warn("[Fyy Loader] ‚ùå Response kosong dari server")
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server tidak merespon")
        end
        return false
    end

    -- Decode JSON response
    local data
    success = pcall(function()
        data = HttpService:JSONDecode(response)
    end)

    if not success or not data then
        warn("[Fyy Loader] ‚ùå Response tidak valid:", response)
        if player then
            player:Kick("[Fyy Loader] ‚ùå Server error - Invalid response")
        end
        return false
    end

    -- Cek status
    if data.status ~= "ok" then
        local errorMessage = data.message or "Key invalid"
        local errorCode = data.code or "UNKNOWN_ERROR"
        
        warn("[Fyy Loader] ‚ùå Validation failed:", errorCode, "-", errorMessage)
        
        -- Custom error messages
        local kickMessages = {
            INVALID_KEY = "Key tidak ditemukan di database",
            BLACKLISTED = "Key telah diblacklist. Hubungi owner.",
            EXPIRED = "Key sudah expired. Beli yang baru!",
            HWID_MISMATCH = "Key sudah terikat ke device lain.\nReset HWID via panel.",
            MISSING_PARAMS = "Parameter tidak lengkap",
            BIND_FAILED = "Gagal bind HWID. Coba lagi."
        }
        
        local kickMsg = kickMessages[errorCode] or errorMessage
        
        if player then
            player:Kick("[Fyy Loader] ‚ùå " .. kickMsg .. "\n\nError Code: " .. errorCode)
        end
        return false
    end

    -- SUCCESS!
    print("[Fyy Loader] ‚úÖ Validation SUCCESS!")
    print("  Code:", data.code)
    print("  Message:", data.message)
    
    if data.userInfo then
        print("  Username:", data.userInfo.robloxUsername or "N/A")
        print("  Game:", data.userInfo.gameName or "N/A")
    end
    
    return true
end

-- ================================
-- DOWNLOAD SCRIPT FUNCTION
-- ================================
local function downloadScript()
    if not _G.script_key then
        error("[Fyy Loader] No key found for script download")
    end
    
    local player = Players.LocalPlayer
    local hwid = getHWID()
    local username = player and player.Name or "UNKNOWN"
    local robloxId = player and player.UserId or 0
    
    -- Buat URL untuk download script dengan endpoint secret
    local url = string.format(
        "%s?key=%s&hwid=%s&robloxId=%s&username=%s",
        SCRIPT_URL,
        HttpService:UrlEncode(_G.script_key),
        HttpService:UrlEncode(hwid),
        tostring(robloxId),
        HttpService:UrlEncode(username)
    )
    
    print("[Fyy Loader] üì• Downloading script...")
    print("  URL:", BASE_URL .. SECRET_ENDPOINT)
    print("  Key:", string.sub(_G.script_key, 1, 8) .. "...")
    
    -- Download script dari server
    local success, scriptContent = pcall(function()
        return game:HttpGet(url, true)
    end)
    
    if not success then
        warn("[Fyy Loader] ‚ùå Gagal download script:", scriptContent)
        if player then
            player:Kick("[Fyy Loader] ‚ùå Gagal download script premium\nCoba lagi atau hubungi admin.")
        end
        return nil
    end
    
    if not scriptContent or scriptContent == "" then
        warn("[Fyy Loader] ‚ùå Script content kosong")
        if player then
            player:Kick("[Fyy Loader] ‚ùå Script tidak ditemukan di server")
        end
        return nil
    end
    
    -- Cek jika response adalah error message
    if string.find(scriptContent, "ERROR:") or string.find(scriptContent, "ACCESS DENIED") then
        warn("[Fyy Loader] ‚ùå Server menolak akses script")
        if player then
            player:Kick("[Fyy Loader] ‚ùå Akses script ditolak\n" .. scriptContent)
        end
        return nil
    end
    
    print("[Fyy Loader] ‚úÖ Script downloaded successfully!")
    print("  Size:", #scriptContent, "bytes")
    
    return scriptContent
end

-- ================================
-- MAIN EXECUTION
-- ================================

print([[
=======================================
üéÆ FYY PREMIUM LOADER v2.0
=======================================
]])

-- 1. Validasi key terlebih dahulu
print("[Fyy Loader] üîê Starting validation...")
local isValid = validateKey()

if not isValid then
    print("[Fyy Loader] ‚ùå Validation failed. Stopping...")
    return
end

print("[Fyy Loader] ‚úÖ Validation passed!")

-- 2. Download script dari server
print("[Fyy Loader] üöÄ Downloading premium script...")
local scriptContent = downloadScript()

if not scriptContent then
    print("[Fyy Loader] ‚ùå Failed to download script")
    return
end

-- 3. Execute script utama
print("[Fyy Loader] ‚ö° Executing premium script...")
local success, errorMsg = pcall(function()
    loadstring(scriptContent)()
end)

if not success then
    warn("[Fyy Loader] ‚ùå Error executing script:", errorMsg)
    
    -- Tampilkan error yang lebih detail
    local player = Players.LocalPlayer
    if player then
        player:Kick("[Fyy Loader] ‚ùå Script execution error:\n" .. tostring(errorMsg))
    end
else
    print("[Fyy Loader] ‚úÖ Premium script executed successfully!")
    print("=======================================")
    print("üéâ Enjoy the premium features!")
    print("=======================================")
end

-- ================================
-- AUTOMATIC RE-VALIDATION (OPTIONAL)
-- ================================
--[[
spawn(function()
    while wait(60) do -- Re-validate setiap 60 detik
        if not validateKey() then
            local player = Players.LocalPlayer
            if player then
                player:Kick("[Fyy Loader] ‚ùå Session expired")
            end
            break
        end
    end
end)
]]
