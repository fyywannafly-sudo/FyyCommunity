local HttpService = game:GetService("HttpService")

-- Konfigurasi
local CONFIG = {
    BASE_URL = "http://151.240.0.25:3000",
    MIN_KEY_LENGTH = 9
}

-- Helper functions
local function kickPlayer(message)
    local player = game.Players.LocalPlayer
    if player then
        player:Kick("Fyy: " .. message)
    end
    return false
end

local function getKey()
    -- Priority 1: _G.script_key
    if _G.script_key and type(_G.script_key) == "string" then
        if #_G.script_key < CONFIG.MIN_KEY_LENGTH then
            return nil, "Key too short (min " .. CONFIG.MIN_KEY_LENGTH .. " chars)"
        end
        return _G.script_key
    end
    
    -- Priority 2: _G.key (alternatif)
    if _G.key and type(_G.key) == "string" and #_G.key >= CONFIG.MIN_KEY_LENGTH then
        _G.script_key = _G.key
        return _G.key
    end
    
    return nil, "Please set _G.script_key = 'YOUR_KEY'"
end

-- Main execution
local function main()
    -- Get and validate key
    local key, keyError = getKey()
    if not key then
        return kickPlayer(keyError or "Invalid key")
    end
    
    -- Get HWID
    local hwid = game:GetService("RbxAnalyticsService"):GetClientId()
    
    -- Step 1: Validate key with server
    local validateUrl = CONFIG.BASE_URL .. "/validate?key=" .. HttpService:UrlEncode(key) .. "&hwid=" .. HttpService:UrlEncode(hwid)
    local success, response = pcall(game.HttpGet, game, validateUrl, true)
    
    if not success or not response then
        return kickPlayer("Cannot connect to server")
    end
    
    local data = pcall(HttpService.JSONDecode, HttpService, response)
    if not data or data.status ~= "ok" then
        return kickPlayer(data and data.message or "Invalid key")
    end
    
    -- Step 2: Download script
    local scriptUrl = CONFIG.BASE_URL .. "/script?key=" .. HttpService:UrlEncode(key) .. "&hwid=" .. HttpService:UrlEncode(hwid)
    success, response = pcall(game.HttpGet, game, scriptUrl, true)
    
    if not success or not response then
        return kickPlayer("Failed to download script")
    end
    
    -- Step 3: Execute
    local execSuccess, errorMsg = pcall(loadstring, response)
    if not execSuccess then
        return kickPlayer("Script error: " .. tostring(errorMsg):sub(1, 80))
    end
end

-- Safe start dengan error handling
local ok, err = pcall(main)
if not ok then
    kickPlayer("Loader error: " .. tostring(err):sub(1, 80))
end
